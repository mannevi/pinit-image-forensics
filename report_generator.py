from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
from reportlab.pdfgen import canvas
from textwrap import wrap
from datetime import datetime
import os

# ==============================
# PAGE CONFIG
# ==============================
PAGE_WIDTH, PAGE_HEIGHT = A4
LEFT = 2 * cm
RIGHT = PAGE_WIDTH - 2 * cm
TOP = PAGE_HEIGHT - 2 * cm
BOTTOM = 2 * cm
LINE = 0.45 * cm


# ==============================
# HELPERS
# ==============================
def safe(v, default="Not Available"):
    return default if v in (None, "", []) else v


def ensure_space(c, y, needed=LINE * 3):
    if y < BOTTOM + needed:
        c.showPage()
        c.setFont("Helvetica", 10)
        return TOP
    return y


def draw_title(c, y):
    c.setFont("Helvetica-Bold", 16)
    c.drawString(LEFT, y, "PinIT Image Forensics & Risk Assessment Report")
    return y - LINE * 2


def draw_section(c, title, y):
    y = ensure_space(c, y)
    c.setFont("Helvetica-Bold", 12)
    c.drawString(LEFT, y, title)
    return y - LINE * 1.5


def draw_text(c, text, y, width=95):
    c.setFont("Helvetica", 10)
    for line in wrap(str(text), width):
        y = ensure_space(c, y)
        c.drawString(LEFT, y, line)
        y -= LINE
    return y


def draw_bullets(c, items, y):
    if not items:
        return draw_text(c, "• No significant indicators detected.", y)
    for item in items:
        y = draw_text(c, f"• {item}", y)
    return y


def divider(c, y):
    y = ensure_space(c, y)
    c.line(LEFT, y, RIGHT, y)
    return y - LINE


# ==============================
# MAIN REPORT BUILDER
# ==============================
def build_pdf_report(analysis: dict, pdf_path: str, report_id: str):
    os.makedirs(os.path.dirname(pdf_path), exist_ok=True)

    c = canvas.Canvas(pdf_path, pagesize=A4)
    y = TOP

    # -------- HEADER --------
    y = draw_title(c, y)

    y = draw_text(c, "Prepared for: Insurance Claims & Fraud Investigation Team", y)
    y = draw_text(c, "Generated by: PinIT – Digital Intelligence Platform", y)
    y = draw_text(c, "Report Type: Digital Image Authenticity & Risk Analysis", y)
    y = draw_text(c, f"Report ID: {report_id}", y)
    y = draw_text(c, f"Date: {datetime.now().strftime('%d %b %Y')}", y)
    y = divider(c, y)

    scores = analysis.get("scores", {})
    overview = analysis.get("image_overview", {})
    exif = analysis.get("exif_summary", {})
    ai = analysis.get("ai_detection", {})
    tamper = analysis.get("tampering", {})
    drivers = analysis.get("risk_drivers", [])

    # -------- 1 --------
    y = draw_section(c, "1. Executive Summary", y)
    y = draw_text(
        c,
        f"Overall Finding: {safe(scores.get('overall_label'))}. "
        f"Authenticity Confidence Score: {safe(scores.get('overall_risk'))} / 100. "
        "This image was analyzed using metadata intelligence, tamper detection, "
        "and AI-assisted content analysis.",
        y,
    )
    y = divider(c, y)

    # -------- 2 --------
    y = draw_section(c, "2. Image Overview", y)
    y = draw_text(c, f"Image Type: {safe(overview.get('format'))}", y)
    y = draw_text(c, f"File Size: {safe(overview.get('file_size'))}", y)
    y = draw_text(c, f"Resolution: {safe(overview.get('resolution'))}", y)
    y = draw_text(c, f"Color Space: {safe(overview.get('color_space'))}", y)
    y = draw_text(c, f"SHA-256 Hash: {safe(overview.get('sha256'))}", y)
    y = divider(c, y)

    # -------- 3 --------
    y = draw_section(c, "3. Image Authenticity Score", y)
    y = draw_text(c, f"Authenticity Confidence Score: {safe(scores.get('overall_risk'))} / 100", y)
    y = draw_text(c, "80–100: Highly Authentic", y)
    y = draw_text(c, "60–79: Partially Authentic", y)
    y = draw_text(c, "40–59: Suspicious", y)
    y = draw_text(c, "Below 40: High Fraud Risk", y)
    y = divider(c, y)

    # -------- 4 --------
    y = draw_section(c, "4. Capture Encryption & Chain of Custody", y)
    y = draw_text(c, f"Secure Capture UUID Present: {analysis.get('uuid_present', False)}", y)
    y = draw_text(c, "Encryption: AES-256 at capture (if secure capture enabled)", y)
    y = draw_text(c, "Transport Security: TLS 1.3", y)
    y = draw_text(c, f"Chain of Custody Status: {analysis.get('chain_of_custody', 'Not Verifiable')}", y)
    y = divider(c, y)

    # -------- 5 --------
    y = draw_section(c, "5. Metadata Analysis Report", y)
    y = draw_text(c, f"Device Make: {safe(exif.get('device_make'))}", y)
    y = draw_text(c, f"Device Model: {safe(exif.get('device_model'))}", y)
    y = draw_text(c, f"Timestamp: {safe(exif.get('datetime'))}", y)
    y = draw_text(c, f"Software Tag: {safe(exif.get('software'))}", y)
    y = draw_text(c, f"GPS Data Present: {exif.get('gps_present', False)}", y)
    y = draw_text(c, f"Metadata Integrity Score: {safe(scores.get('metadata_score'))} / 100", y)
    y = divider(c, y)

    # -------- 6 --------
    y = draw_section(c, "6. Tampering & Manipulation Analysis", y)
    y = draw_text(c, f"ELA Score: {safe(tamper.get('ela_score'))}", y)
    y = draw_text(c, f"Tampering Probability: {safe(tamper.get('probability'))}%", y)
    y = draw_text(c, "Indicators: Compression inconsistency, edge smoothing, noise anomalies.", y)
    y = divider(c, y)

    # -------- 7 --------
    y = draw_section(c, "7. Deepfake & Synthetic Content Detection", y)
    y = draw_text(c, f"AI Detection Enabled: {safe(ai.get('enabled'))}", y)
    y = draw_text(c, f"AI Likelihood Score: {safe(ai.get('ai_generated_likelihood'))} / 100", y)
    y = draw_text(c, f"Classification: {safe(ai.get('label'))}", y)
    y = divider(c, y)

    # -------- 8 --------
    y = draw_section(c, "8. Duplicate & Reuse Image Check", y)
    y = draw_text(
        c,
        "No exact duplicate found in local index. "
        "Web-scale reverse image search not enabled in this version.",
        y,
    )
    y = divider(c, y)

    # -------- 9 --------
    y = draw_section(c, "9. Geo & Timestamp Verification", y)
    y = draw_text(
        c,
        "Geo-location and timestamp verification performed using available metadata "
        "and visual cues. Confidence reduced if metadata is missing.",
        y,
    )
    y = divider(c, y)

    # -------- 10 --------
    y = draw_section(c, "10. Risk Classification", y)
    y = draw_text(c, f"Metadata Integrity Score: {safe(scores.get('metadata_score'))}", y)
    y = draw_text(c, f"Tampering Indicators Score: {safe(scores.get('tampering_score'))}", y)
    y = draw_text(c, f"AI Risk Score: {safe(scores.get('ai_score'))}", y)
    y = draw_text(c, f"Overall Risk Rating: {safe(scores.get('overall_label'))}", y)
    y = divider(c, y)

    # -------- 11 --------
    y = draw_section(c, "11. PinIT Recommendation to Insurance Team", y)
    y = draw_text(
        c,
        analysis.get(
            "recommendation",
            "Manual review recommended. Request original image file and supporting evidence."
        ),
        y,
    )
    y = divider(c, y)

    # -------- 12 --------
    y = draw_section(c, "12. Legal & Compliance Disclaimer", y)
    y = draw_text(
        c,
        "This report is generated using automated forensic analysis and AI models. "
        "Results are probability-based and must be evaluated alongside human judgment. "
        "PinIT does not make final claim approval or rejection decisions.",
        y,
    )

    c.showPage()
    c.save()
