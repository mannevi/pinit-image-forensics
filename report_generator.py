import os
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
from reportlab.lib import colors
from reportlab.platypus import (
    SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, PageBreak, Image
)
from reportlab.lib.styles import getSampleStyleSheet


def safe(d, k, default="Not Available"):
    return d[k] if k in d else default


def build_pdf_report(analysis: dict, pdf_path: str, report_id: str):
    styles = getSampleStyleSheet()
    H = styles["Heading2"]
    N = styles["BodyText"]

    doc = SimpleDocTemplate(
        pdf_path,
        pagesize=A4,
        rightMargin=1.6 * cm,
        leftMargin=1.6 * cm,
        topMargin=1.6 * cm,
        bottomMargin=1.6 * cm,
    )

    story = []

    # -------------------------
    # COVER / HEADER
    # -------------------------
    story.append(Paragraph("PinIT Image Forensics & Risk Assessment Report", styles["Title"]))
    story.append(Spacer(1, 8))
    story.append(Paragraph("Prepared for: Insurance Claims & Fraud Investigation Team", N))
    story.append(Paragraph("Generated by: PinIT – Digital Intelligence Platform", N))
    story.append(Paragraph("Report Type: Digital Image Authenticity & Risk Analysis", N))
    story.append(Paragraph(f"Report ID: {report_id}", N))
    story.append(Paragraph(f"Date: {analysis['generated_at']}", N))
    story.append(Spacer(1, 14))

    # -------------------------
    # 1. Executive Summary
    # -------------------------
    story.append(Paragraph("1. Executive Summary", H))
    es = analysis["executive_summary"]
    story.append(Paragraph(f"<b>Overall Finding:</b> {es['overall_finding']}", N))
    story.append(Paragraph(es["finding_details"], N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 2. Image Overview
    # -------------------------
    story.append(Paragraph("2. Image Overview", H))
    ov = analysis["image_overview"]

    story.append(Paragraph(f"<b>Capture Method:</b> {safe(ov,'capture_method')}", N))
    story.append(Paragraph(f"<b>User UUID Embedded:</b> {safe(ov,'user_uuid_embedded')}", N))
    story.append(Paragraph(f"<b>Capture Integrity Status:</b> {safe(ov,'capture_integrity_status')}", N))
    story.append(Spacer(1, 6))

    table = Table(
        [
            ["Field", "Value"],
            ["Image Type", safe(ov, "image_type")],
            ["File Size", f"{safe(ov,'file_size_mb')} MB"],
            ["Resolution", safe(ov, "resolution")],
            ["Color Space", safe(ov, "color_space")],
            ["Compression Artifacts", safe(ov, "compression_artifacts")],
            ["SHA-256", analysis["file_hash"]["sha256"]],
        ],
        colWidths=[6 * cm, 10 * cm],
    )

    table.setStyle(TableStyle([
        ("GRID", (0,0), (-1,-1), 0.5, colors.grey),
        ("BACKGROUND", (0,0), (-1,0), colors.whitesmoke),
        ("FONTNAME", (0,0), (-1,0), "Helvetica-Bold"),
    ]))

    story.append(table)
    story.append(Spacer(1, 10))

    # -------------------------
    # 3. Image Authenticity Score
    # -------------------------
    story.append(Paragraph("3. Image Authenticity Score", H))
    au = analysis["authenticity"]
    story.append(Paragraph(f"Authenticity Confidence Score: {au['score']} / 100", N))

    score_table = Table(
        [
            ["Score Range", "Interpretation"],
            ["80–100", "Highly Authentic"],
            ["60–79", "Partially Authentic"],
            ["40–59", "Suspicious"],
            ["Below 40", "High Fraud Risk"],
        ],
        colWidths=[6 * cm, 10 * cm],
    )

    story.append(Spacer(1, 6))
    story.append(score_table)
    story.append(Spacer(1, 6))
    story.append(Paragraph(f"<b>PinIT Verdict:</b> {au['label']}", N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 4. Chain of Custody
    # -------------------------
    story.append(Paragraph("4. Capture Encryption & Chain of Custody", H))
    story.append(Paragraph("Chain of custody could not be fully verified for this upload.", N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 5. Metadata Analysis
    # -------------------------
    story.append(Paragraph("5. Metadata Analysis Report", H))
    md = analysis["metadata"]
    story.append(Paragraph(f"Metadata Integrity Score: {md['integrity_score']} / 100", N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 6. Tampering
    # -------------------------
    story.append(Paragraph("6. Tampering & Manipulation Analysis", H))
    tp = analysis["tampering"]
    story.append(Paragraph(f"Tampering Probability: {tp['tampering_probability_pct']}%", N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 7. Deepfake
    # -------------------------
    story.append(Paragraph("7. Deepfake & Synthetic Content Detection", H))
    df = analysis["deepfake"]
    story.append(Paragraph(f"Deepfake Risk Score: {df['risk_score']} / 100", N))
    story.append(Paragraph(df["interpretation"], N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 8. Duplicate
    # -------------------------
    story.append(Paragraph("8. Duplicate & Reuse Image Check", H))
    story.append(Paragraph("No duplicate images found in the system.", N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 9. Geo & Timestamp
    # -------------------------
    story.append(Paragraph("9. Geo & Timestamp Verification", H))
    gt = analysis["geo_time"]
    story.append(Paragraph(f"Geo-Time Confidence Score: {gt['confidence_score']} / 100 ({gt['confidence_level']})", N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 10. Risk Classification
    # -------------------------
    story.append(Paragraph("10. Risk Classification", H))
    rc = analysis["risk_classification"]
    story.append(Paragraph(f"Overall Risk Rating: {rc['overall_risk_rating']}", N))
    story.append(Paragraph(f"Recommended Action: {rc['recommended_action']}", N))
    story.append(Spacer(1, 12))

    # -------------------------
    # 11. Heatmap Page
    # -------------------------
    story.append(PageBreak())
    story.append(Paragraph("11. Visual Manipulation Heatmap", H))
    story.append(Paragraph("Heatmap highlights regions with abnormal compression noise.", N))

    if tp.get("heatmap_path") and os.path.exists(tp["heatmap_path"]):
        story.append(Spacer(1, 8))
        story.append(Image(tp["heatmap_path"], width=16 * cm, height=9 * cm))

    story.append(Spacer(1, 12))

    # -------------------------
    # 12. Recommendation
    # -------------------------
    story.append(Paragraph("12. PinIT Recommendation to Insurance Team", H))
    story.append(Paragraph(
        "• Request original image file directly from device<br/>"
        "• Cross-check claim with additional photos or videos<br/>"
        "• Validate claim timeline with external evidence<br/>"
        "• Flag claim for enhanced fraud review",
        N
    ))

    story.append(Spacer(1, 12))

    # -------------------------
    # 13. Disclaimer
    # -------------------------
    story.append(Paragraph("13. Legal & Compliance Disclaimer", H))
    story.append(Paragraph(
        "This report is generated using automated forensic analysis and heuristic AI checks. "
        "Results indicate probability-based assessments and should be used alongside human judgment.",
        N
    ))

    story.append(Spacer(1, 10))
    story.append(Paragraph("Prepared by: PinIT – Protecting Trust in Digital Evidence", N))

    doc.build(story)
