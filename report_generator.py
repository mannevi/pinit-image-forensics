from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
from reportlab.pdfgen import canvas
from textwrap import wrap
import os
from datetime import datetime

PAGE_W, PAGE_H = A4
LEFT = 2 * cm
RIGHT = PAGE_W - 2 * cm
TOP = PAGE_H - 2 * cm
BOTTOM = 2 * cm
LINE = 0.45 * cm


def safe(v, default="Not Available"):
    return default if v in (None, "", []) else v


def ensure_space(c, y, need=LINE * 3):
    if y < BOTTOM + need:
        c.showPage()
        c.setFont("Helvetica", 10)
        return TOP
    return y


def draw_section(c, y, title):
    y = ensure_space(c, y)
    c.setFont("Helvetica-Bold", 12)
    c.drawString(LEFT, y, title)
    return y - LINE * 1.4


def draw_paragraph(c, y, text, width=95):
    c.setFont("Helvetica", 10)
    for ln in wrap(str(text), width):
        y = ensure_space(c, y)
        c.drawString(LEFT, y, ln)
        y -= LINE
    return y


def draw_bullets(c, y, items):
    if not items:
        return draw_paragraph(c, y, "• No significant indicators detected.", 95)
    for it in items:
        y = draw_paragraph(c, y, f"• {it}", 95)
    return y


def divider(c, y):
    y = ensure_space(c, y)
    c.line(LEFT, y, RIGHT, y)
    return y - LINE


def build_pdf_report(analysis: dict, pdf_path: str, report_id: str):
    os.makedirs(os.path.dirname(pdf_path), exist_ok=True)
    c = canvas.Canvas(pdf_path, pagesize=A4)
    y = TOP

    scores = analysis.get("scores", {})
    overview = analysis.get("image_overview", {})
    exif = analysis.get("exif_summary", {})
    tamper = analysis.get("tampering", {})
    ai = analysis.get("ai_detection", {})
    dup = analysis.get("duplicate_check", {})
    geo = analysis.get("geo_time", {})

    # Header
    c.setFont("Helvetica-Bold", 16)
    c.drawString(LEFT, y, "PinIT Image Forensics & Risk Assessment Report")
    y -= LINE * 2

    y = draw_paragraph(c, y, "Prepared for: Insurance Claims & Fraud Investigation Team")
    y = draw_paragraph(c, y, "Generated by: PinIT – Digital Intelligence Platform")
    y = draw_paragraph(c, y, "Report Type: Digital Image Authenticity & Risk Analysis")
    y = draw_paragraph(c, y, f"Report ID: {report_id}")
    y = draw_paragraph(c, y, f"Date: {analysis.get('generated_at', datetime.utcnow().strftime('%d %b %Y'))}")
    y = divider(c, y)

    # 1 Executive Summary
    y = draw_section(c, y, "1. Executive Summary")
    y = draw_paragraph(
        c, y,
        f"Overall Finding: {safe(scores.get('overall_label'))}. "
        f"Authenticity Confidence Score: {safe(scores.get('overall_risk'))} / 100. "
        "This image was analyzed using metadata intelligence, tamper detection, and AI-assisted content analysis."
    )
    y = divider(c, y)

    # 2 Image Overview
    y = draw_section(c, y, "2. Image Overview")
    y = draw_paragraph(c, y, f"Image Type: {safe(overview.get('format'))}")
    y = draw_paragraph(c, y, f"File Size: {safe(overview.get('file_size'))}")
    y = draw_paragraph(c, y, f"Resolution: {safe(overview.get('resolution'))}")
    y = draw_paragraph(c, y, f"Color Space: {safe(overview.get('color_space'))}")
    y = draw_paragraph(c, y, f"SHA-256 Hash: {safe(overview.get('sha256'))}")
    y = divider(c, y)

    # 3 Image Authenticity Score
    y = draw_section(c, y, "3. Image Authenticity Score")
    y = draw_paragraph(c, y, f"Authenticity Confidence Score: {safe(scores.get('overall_risk'))} / 100")
    y = draw_paragraph(c, y, "80–100: Highly Authentic")
    y = draw_paragraph(c, y, "60–79: Partially Authentic")
    y = draw_paragraph(c, y, "40–59: Suspicious")
    y = draw_paragraph(c, y, "Below 40: High Fraud Risk")
    y = divider(c, y)

    # 4 Chain of Custody
    y = draw_section(c, y, "4. Capture Encryption & Chain of Custody")
    y = draw_paragraph(c, y, f"Secure Capture UUID Present: {analysis.get('uuid_present', False)}")
    y = draw_paragraph(c, y, "Encryption: AES-256 at capture (if secure capture enabled)")
    y = draw_paragraph(c, y, "Upload Transport Security: TLS 1.3")
    y = draw_paragraph(c, y, f"Chain of Custody Status: {analysis.get('chain_of_custody', 'Not Available')}")
    y = divider(c, y)

    # 5 Metadata
    y = draw_section(c, y, "5. Metadata Analysis Report")
    y = draw_paragraph(c, y, f"Device Make: {safe(exif.get('device_make'), 'Unknown')}")
    y = draw_paragraph(c, y, f"Device Model: {safe(exif.get('device_model'), 'Unknown')}")
    y = draw_paragraph(c, y, f"Timestamp: {safe(exif.get('datetime'), 'Unknown')}")
    y = draw_paragraph(c, y, f"Software Tag: {safe(exif.get('software'), 'Unknown')}")
    y = draw_paragraph(c, y, f"GPS Data Present: {exif.get('gps_present', False)}")
    y = draw_paragraph(c, y, f"Metadata Integrity Score: {safe(scores.get('metadata_score'))} / 100")
    y = divider(c, y)

    # 6 Tampering
    y = draw_section(c, y, "6. Tampering & Manipulation Analysis")
    y = draw_paragraph(c, y, f"ELA Score: {safe(tamper.get('ela_score'))}")
    y = draw_paragraph(c, y, f"Tampering Probability: {safe(tamper.get('probability'))}%")
    findings = tamper.get("findings", [])
    y = draw_paragraph(c, y, "Findings:")
    y = draw_bullets(c, y, findings)
    y = divider(c, y)

    # 7 Deepfake/Synthetic
    y = draw_section(c, y, "7. Deepfake & Synthetic Content Detection")
    y = draw_paragraph(c, y, f"AI Detection Enabled: {safe(ai.get('enabled'))}")
    y = draw_paragraph(c, y, f"AI Likelihood Score: {safe(ai.get('ai_generated_likelihood'))} / 100")
    y = draw_paragraph(c, y, f"Classification: {safe(ai.get('label'))}")
    y = divider(c, y)

    # 8 Duplicate check
    y = draw_section(c, y, "8. Duplicate & Reuse Image Check")
    y = draw_paragraph(c, y, f"Exact Match: {safe(dup.get('exact_match'))}")
    y = draw_paragraph(c, y, f"Near-Duplicate Match: {safe(dup.get('near_duplicate'))}")
    y = draw_paragraph(c, y, f"Reuse Risk Level: {safe(dup.get('reuse_risk'))}")
    y = divider(c, y)

    # 9 Geo/time
    y = draw_section(c, y, "9. Geo & Timestamp Verification")
    y = draw_paragraph(c, y, f"Claimed Location: {safe(geo.get('claimed_location'))}")
    y = draw_paragraph(c, y, f"Visual Landmark Match: {safe(geo.get('visual_landmark_match'))}")
    y = draw_paragraph(c, y, f"Weather Consistency: {safe(geo.get('weather_consistency'))}")
    y = draw_paragraph(c, y, f"Shadow Direction: {safe(geo.get('shadow_direction'))}")
    y = draw_paragraph(c, y, f"Geo-Time Confidence Score: {safe(geo.get('geo_time_score'))}")
    y = divider(c, y)

    # 10 Risk classification
    y = draw_section(c, y, "10. Risk Classification")
    y = draw_paragraph(c, y, f"Metadata Integrity Score: {safe(scores.get('metadata_score'))}")
    y = draw_paragraph(c, y, f"Tampering Indicators Score: {safe(scores.get('tampering_score'))}")
    y = draw_paragraph(c, y, f"AI Risk Score: {safe(scores.get('ai_score'))}")
    y = draw_paragraph(c, y, f"Overall Risk Rating: {safe(scores.get('overall_label'))}")
    y = divider(c, y)

    # 11 Recommendation
    y = draw_section(c, y, "11. PinIT Recommendation to Insurance Team")
    y = draw_paragraph(c, y, safe(analysis.get("recommendation")))
    y = divider(c, y)

    # 12 Disclaimer
    y = draw_section(c, y, "12. Legal & Compliance Disclaimer")
    y = draw_paragraph(
        c, y,
        "This report is generated using automated forensic analysis and AI models. "
        "Results are probability-based and must be evaluated alongside human judgment. "
        "PinIT does not make final claim approval or rejection decisions."
    )

    c.showPage()
    c.save()
