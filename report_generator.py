from reportlab.lib.pagesizes import A4
from reportlab.lib.units import cm
from reportlab.pdfgen import canvas
from reportlab.lib import colors as rl
from textwrap import wrap
import os

PAGE_W, PAGE_H = A4
LEFT = 2 * cm
RIGHT = PAGE_W - 2 * cm
TOP = PAGE_H - 2 * cm
BOTTOM = 2 * cm
LINE = 0.48 * cm

def _hex_to_color(hex_str: str):
    hex_str = (hex_str or "#000000").lstrip("#")
    r = int(hex_str[0:2], 16) / 255.0
    g = int(hex_str[2:4], 16) / 255.0
    b = int(hex_str[4:6], 16) / 255.0
    return rl.Color(r, g, b)

def _ensure(c, y, need=LINE * 3):
    if y < BOTTOM + need:
        c.showPage()
        c.setFont("Helvetica", 10)
        return TOP
    return y

def _draw_line(c, y, text, bold=False, size=10):
    c.setFont("Helvetica-Bold" if bold else "Helvetica", size)
    c.drawString(LEFT, y, text)
    return y - LINE

def _para(c, y, text, width=95):
    for ln in wrap(str(text), width):
        y = _ensure(c, y)
        y = _draw_line(c, y, ln)
    return y

def _divider(c, y):
    y = _ensure(c, y)
    c.setStrokeColor(rl.lightgrey)
    c.line(LEFT, y, RIGHT, y)
    return y - LINE

def _section_title(c, y, title):
    y = _ensure(c, y)
    c.setFont("Helvetica-Bold", 12)
    c.drawString(LEFT, y, title)
    return y - LINE * 1.4

def _risk_badge(c, y, label, score, color_hex):
    y = _ensure(c, y, need=LINE * 4)
    col = _hex_to_color(color_hex)
    c.setFillColor(col)
    c.roundRect(LEFT, y - 10, 13 * cm, 18, 8, fill=1, stroke=0)
    c.setFillColor(rl.white)
    c.setFont("Helvetica-Bold", 10)
    c.drawString(LEFT + 10, y - 6, f"{label}  |  Authenticity Score: {score} / 100")
    c.setFillColor(rl.black)
    return y - LINE * 2

def _table(c, y, title, rows, col_widths):
    y = _section_title(c, y, title)
    y = _ensure(c, y, need=LINE * (len(rows) + 4))

    # header background
    c.setFillColor(rl.whitesmoke)
    c.rect(LEFT, y - 12, RIGHT - LEFT, 16, fill=1, stroke=0)
    c.setFillColor(rl.black)
    c.setFont("Helvetica-Bold", 10)
    c.drawString(LEFT + 4, y - 8, "Attribute")
    c.drawString(LEFT + col_widths[0] + 4, y - 8, "Status")
    c.drawString(LEFT + col_widths[0] + col_widths[1] + 4, y - 8, "Details")
    y -= LINE * 1.2

    c.setFont("Helvetica", 10)
    for a, s, d in rows:
        y = _ensure(c, y, need=LINE * 3)
        c.drawString(LEFT + 4, y, str(a))
        c.drawString(LEFT + col_widths[0] + 4, y, str(s))
        # wrap details
        dd = wrap(str(d), 55)
        c.drawString(LEFT + col_widths[0] + col_widths[1] + 4, y, dd[0] if dd else "")
        y -= LINE
        for extra in dd[1:]:
            y = _ensure(c, y)
            c.drawString(LEFT + col_widths[0] + col_widths[1] + 4, y, extra)
            y -= LINE

    return _divider(c, y)

def build_pdf_report(analysis: dict, pdf_path: str, report_id: str):
    os.makedirs(os.path.dirname(pdf_path), exist_ok=True)
    c = canvas.Canvas(pdf_path, pagesize=A4)
    y = TOP

    risk_hex = analysis.get("colors", {}).get("risk_hex", "#FF9F1C")
    risk_color = _hex_to_color(risk_hex)

    # Top color bar
    c.setFillColor(risk_color)
    c.rect(0, PAGE_H - 10, PAGE_W, 10, fill=1, stroke=0)
    c.setFillColor(rl.black)

    # Header (matches DOCX)
    y = _draw_line(c, y, "PinIT Image Forensics & Risk Assessment Report", bold=True, size=15)
    y = _para(c, y, "Prepared for: Insurance Claims & Fraud Investigation Team")
    y = _para(c, y, "Generated by: PinIT – Digital Intelligence Platform")
    y = _para(c, y, "Report Type: Digital Image Authenticity & Risk Analysis")
    y = _para(c, y, f"Report ID: {report_id}")
    y = _para(c, y, f"Date: {analysis.get('generated_at', 'N/A')}")
    y = _divider(c, y)

    scores = analysis.get("scores", {})
    overview = analysis.get("image_overview", {})
    capture = analysis.get("capture", {})
    exif = analysis.get("exif_summary", {})
    tampering = analysis.get("tampering", {})
    ai = analysis.get("ai_detection", {})
    dup = analysis.get("duplicate_check", {})
    geo = analysis.get("geo_time", {})

    # 1. Executive Summary
    y = _section_title(c, y, "1. Executive Summary")
    y = _para(c, y, "PinIT analyzed the submitted claim image using advanced image forensics, metadata intelligence, tamper detection, and AI-based analysis.")
    y = _para(c, y, "Overall Finding:")
    y = _risk_badge(c, y, scores.get("overall_label", "N/A"), scores.get("overall_risk", "N/A"), risk_hex)
    if scores.get("overall_label") in ("Highly Authentic", "Low Risk"):
        y = _para(c, y, "The image shows consistent metadata and low manipulation indicators. Evidence appears reliable for standard claim processing.")
    elif scores.get("overall_label") == "Medium–High Risk":
        y = _para(c, y, "The image shows inconsistencies across metadata and tampering indicators. While partially authentic, there are signals of alteration requiring review.")
    else:
        y = _para(c, y, "The image exhibits strong manipulation indicators and/or missing evidence signals. Escalation for enhanced fraud review is recommended.")
    y = _divider(c, y)

    # 2. Image Overview (as in DOCX)
    y = _section_title(c, y, "2. Image Overview")
    y = _para(c, y, f"Capture Method: {capture.get('capture_method', 'N/A')}")
    y = _para(c, y, f"User UUID Embedded: {overview.get('uuid', 'N/A')}")
    y = _para(c, y, f"Capture Integrity Status: {capture.get('capture_integrity_status', 'N/A')}")
    y = _para(c, y, f"• Image Type: {overview.get('image_type', 'N/A')}")
    y = _para(c, y, f"• File Size: {overview.get('file_size', 'N/A')}")
    y = _para(c, y, f"• Resolution: {overview.get('resolution', 'N/A')}")
    y = _para(c, y, f"• Color Space: {overview.get('color_space', 'N/A')}")
    y = _para(c, y, f"• Compression Artifacts: {overview.get('compression_artifacts', 'N/A')}")
    y = _para(c, y, "Embedded Security Layers: - User UUID embedded at capture - Device-bound capture session - Tamper-evident signature (if secure capture enabled)")
    y = _divider(c, y)

    # 3. Image Authenticity Score (table-like text)
    y = _section_title(c, y, "3. Image Authenticity Score")
    y = _para(c, y, f"Authenticity Confidence Score: {scores.get('overall_risk', 'N/A')} / 100", width=95)
    y = _para(c, y, "Score Range      Interpretation")
    y = _para(c, y, "80–100           Highly Authentic")
    y = _para(c, y, "60–79            Partially Authentic")
    y = _para(c, y, "40–59            Suspicious")
    y = _para(c, y, "Below 40         High Fraud Risk")
    y = _para(c, y, f"PinIT Verdict: {scores.get('overall_label', 'N/A')}.")
    y = _divider(c, y)

    # 4. Capture Encryption & Chain of Custody (TABLE like DOCX)
    custody_rows = [
        ("Capture-Time Encryption", "Enabled" if capture.get("secure_capture") else "Not Verified", "AES-256 applied on device (secure capture only)"),
        ("User Identity Binding", "Yes" if capture.get("secure_capture") else "No", "UUID linked to authenticated user (secure capture only)"),
        ("Image-Level UUID Injection", "Yes" if capture.get("secure_capture") else "No", "Embedded within image payload (secure capture only)"),
        ("Post-Capture Editing", "Blocked" if capture.get("secure_capture") else "Allowed", "Capture-only mode prevents edits (secure capture only)"),
        ("Hash Generated at Capture", "SHA-256", "Stored for integrity comparison"),
        ("Upload Transport Security", "TLS 1.3", "Encrypted in transit"),
        ("Server-Side Re-Encryption", "Yes", "Encrypted at rest (if configured)"),
    ]
    y = _table(c, y, "4. Capture Encryption & Chain of Custody", custody_rows, [6 * cm, 3 * cm, (RIGHT - LEFT) - 9 * cm])
    y = _para(c, y, f"Chain of Custody Status: {capture.get('chain_of_custody_status', 'N/A')}")
    y = _divider(c, y)

    # 5. Metadata Analysis Report (table-like)
    y = _section_title(c, y, "5. Metadata Analysis Report")
    y = _para(c, y, f"EXIF Metadata Status: {'Present' if exif.get('exif_present') else 'Missing / Stripped'}")
    y = _para(c, y, f"Device Make: {exif.get('device_make', 'N/A')}")
    y = _para(c, y, f"Device Model: {exif.get('device_model', 'N/A')}")
    y = _para(c, y, f"Date & Time: {exif.get('datetime', 'N/A')}")
    y = _para(c, y, f"GPS Data: {'Available' if exif.get('gps_present') else 'Removed / Not Present'}")
    y = _para(c, y, f"Software Tag: {exif.get('software', 'N/A')}")
    y = _para(c, y, f"Metadata Integrity Score: {scores.get('metadata_score', 'N/A')} / 100")
    y = _divider(c, y)

    # 6. Tampering & Manipulation Analysis
    y = _section_title(c, y, "6. Tampering & Manipulation Analysis")
    y = _para(c, y, "PinIT applied Error Level Analysis (ELA) and compression/noise inconsistency scoring.")
    y = _para(c, y, "Findings:")
    findings = tampering.get("findings", [])
    if findings:
        for f in findings:
            y = _para(c, y, f"- {f}")
    y = _para(c, y, f"ELA Mean: {tampering.get('ela_mean', 'N/A')}")
    y = _para(c, y, f"ELA 95th Percentile: {tampering.get('ela_p95', 'N/A')}")
    y = _para(c, y, f"Tampering Probability: {tampering.get('probability', 'N/A')}%")
    y = _divider(c, y)

    # 7. Deepfake & Synthetic Content Detection (as DOCX)
    y = _section_title(c, y, "7. Deepfake & Synthetic Content Detection")
    y = _para(c, y, "AI-based models and heuristics were applied to assess synthetic generation or AI-assisted edits.")
    y = _para(c, y, f"AI-Generated Content: {ai.get('label', 'N/A')}")
    y = _para(c, y, f"AI Likelihood Score: {ai.get('ai_generated_likelihood', 'N/A')} / 100")
    y = _divider(c, y)

    # 8. Duplicate & Reuse Image Check (as DOCX)
    y = _section_title(c, y, "8. Duplicate & Reuse Image Check")
    y = _para(c, y, "PinIT compared the image against available local indexing. Web-scale matching can be enabled as an upgrade.")
    y = _para(c, y, f"Exact Match: {dup.get('exact_match', 'Not Implemented')}")
    y = _para(c, y, f"Near-Duplicate Match: {dup.get('near_duplicate', 'Not Implemented')}")
    y = _para(c, y, f"Reuse Risk Level: {dup.get('reuse_risk', 'Not Implemented')}")
    y = _divider(c, y)

    # 9. Geo & Timestamp Verification (as DOCX)
    y = _section_title(c, y, "9. Geo & Timestamp Verification")
    y = _para(c, y, "PinIT cross-validates EXIF, visual cues, and external signals (weather/shadow) when enabled.")
    y = _para(c, y, f"Claimed Location: {geo.get('claimed_location', 'N/A')}")
    y = _para(c, y, f"Visual Landmark Match: {geo.get('visual_landmark_match', 'Not Implemented')}")
    y = _para(c, y, f"Weather Consistency: {geo.get('weather_consistency', 'Not Implemented')}")
    y = _para(c, y, f"Shadow Direction: {geo.get('shadow_direction', 'Not Implemented')}")
    y = _para(c, y, f"Geo-Time Confidence Score: {geo.get('geo_time_score', 'Not Implemented')}")
    y = _divider(c, y)

    # 10. Visual Manipulation Heatmap (Illustrative) — placeholder box
    y = _section_title(c, y, "10. Visual Manipulation Heatmap (Illustrative)")
    y = _para(c, y, "(Heatmap highlights regions with abnormal noise, compression, and pixel discontinuity)")
    y = _ensure(c, y, need=4 * cm)
    c.setStrokeColor(rl.lightgrey)
    c.rect(LEFT, y - 3.5 * cm, RIGHT - LEFT, 3 * cm, fill=0, stroke=1)
    c.setFont("Helvetica-Oblique", 9)
    c.drawString(LEFT + 10, y - 1.5 * cm, "Heatmap placeholder (enable in next upgrade)")
    y -= 4 * cm
    y = _para(c, y, "Red Zones: High likelihood of manipulation")
    y = _para(c, y, "Orange Zones: Possible edits")
    y = _para(c, y, "Green Zones: No anomalies detected")
    y = _divider(c, y)

    # 11. Recommendation
    y = _section_title(c, y, "11. PinIT Recommendation to Insurance Team")
    y = _para(c, y, analysis.get("recommendation", "N/A"))
    y = _divider(c, y)

    # 12. Disclaimer (as DOCX)
    y = _section_title(c, y, "12. Legal & Compliance Disclaimer")
    y = _para(c, y,
        "Images captured using the PinIT Secure Capture App contain embedded user-level UUIDs, cryptographic hashes, "
        "and capture-time encryption markers. These elements provide a verifiable chain of custody and non-repudiation of digital evidence."
    )
    y = _para(c, y,
        "This report is generated using automated forensic analysis and AI models. Results indicate probability-based assessments "
        "and should be used alongside human judgment and supporting evidence."
    )
    y = _para(c, y, "PinIT does not make final claim approval or rejection decisions.")
    y = _para(c, y, "Prepared by:")
    y = _para(c, y, "PinIT – Protecting Trust in Digital Evidence")
    y = _para(c, y, "This is a sample/demo report with indicative values for presentation and sales discussions.")

    c.showPage()
    c.save()
